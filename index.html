<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Море слов — квадратный стикер + подсказки</title>
  <style>
    :root{
      --notebook-bg:#F8F4E8;
      --line-color:#D4E7F5;
      --margin-line:#FFB6C6;
      --sticker-top:#FFF063;
      --sticker-bottom:#FFC531;
      --sticker-edge:#E6B55B;
      --ink:#2B3856;
      --slot:#6B8CAE;
      --tile-face-top:#FFE36F;
      --tile-face-bottom:#FFC836;
      --tile-ring:#E0AA24;
      --tile-shadow:#C49116;
      --tile-text:#3D2519;
      --accent:#46B85A;
      --accent-dark:#2F7A3A;
      --menu:#fff7e0;
      --menu-border:#e3c679;
    }

    html,body{
      height:100%;
      margin:0;
      font-family:'Segoe Print','Comic Sans MS',system-ui,-apple-system,cursive;
      color:var(--ink);
    }

    body{
      background-color:var(--notebook-bg);
      background-image:
        repeating-linear-gradient(
          transparent,
          transparent 31px,
          var(--line-color) 31px,
          var(--line-color) 33px
        ),
        linear-gradient(
          90deg,
          transparent 79px,
          var(--margin-line) 79px,
          var(--margin-line) 81px,
          transparent 81px
        );
      background-size: 100% 33px, 100% 100%;
      position:relative;
    }

    /* Эффект дырочек от скрепок */
    body:before{
      content:'';
      position:fixed;
      left:40px;
      top:0;
      bottom:0;
      width:2px;
      background:
        repeating-linear-gradient(
          transparent,
          transparent 80px,
          #ccc 80px,
          #ccc 100px,
          transparent 100px
        );
      box-shadow: 
        0 85px 0 0 rgba(0,0,0,.08),
        0 90px 0 0 rgba(255,255,255,.6);
    }

    .wrap{
      max-width:980px;
      margin:0 auto;
      padding:40px 16px 120px 100px;
      position:relative;
    }

    /* Верхняя панель */
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:20px;
      flex-wrap:wrap;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .hamb{
      width:46px;
      height:46px;
      border-radius:50%;
      background:linear-gradient(135deg, #FFD93D, #FFC531);
      display:grid;
      place-items:center;
      box-shadow:0 4px 0 #E0A820,0 10px 18px rgba(0,0,0,.2);
      transform:rotate(-5deg);
    }
    .hamb:before{
      content:"≡";
      font-weight:900;
      color:#6f4f3b;
      font-size:24px;
    }
    h1{
      font-size: clamp(18px,2.4vw,22px);
      margin:0;
      color:#2B3856;
      font-weight:700;
      text-shadow:1px 1px 0 rgba(255,255,255,.8);
    }

    .panel{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .btn{
      appearance:none;
      border:0;
      border-radius:16px;
      padding:10px 16px;
      background:linear-gradient(135deg, #FFE66D, #FFD93D);
      color:#5b3f2f;
      font-weight:800;
      cursor:pointer;
      box-shadow:0 4px 0 #E0B020,0 8px 16px rgba(0,0,0,.15);
      font-family:inherit;
      transform:rotate(-1deg);
      transition:transform .15s;
    }
    .btn:hover{transform:rotate(-1deg) translateY(-2px)}
    .btn:active{transform:rotate(-1deg) translateY(1px)}
    .btn.secondary{
      background:linear-gradient(135deg, #A8E6CF, #81D4AF);
      box-shadow:0 4px 0 #5FB894;
      transform:rotate(1deg);
    }
    .btn.secondary:hover{transform:rotate(1deg) translateY(-2px)}
    .btn.secondary:active{transform:rotate(1deg) translateY(1px)}
    input[type=file]{
      background:#fff;
      border:2px solid #D4E7F5;
      border-radius:12px;
      padding:8px 12px;
      font-family:inherit;
      font-size:13px;
    }
    .mini{
      font-size:13px;
      opacity:.85;
      color:#5B6B85;
      font-style:italic;
    }

    /* Счетчики */
    .hud{
      display:flex;
      gap:10px;
      align-items:center;
      margin:12px 0 20px;
    }
    .pill{
      background:rgba(255,255,255,.85);
      padding:10px 16px;
      border-radius:20px;
      border:2px solid #D4E7F5;
      color:#2B3856;
      font-weight:700;
      box-shadow:0 3px 8px rgba(0,0,0,.08);
    }

    /* КВАДРАТНЫЙ СТИКЕР */
    .sticker{
      position:relative;
      margin:20px auto 20px;
      width:min(420px,48vw);
      aspect-ratio:1/1;
      background:
        radial-gradient(80px 50px at 25% 18%, rgba(255,255,255,.65), rgba(255,255,255,0) 60%),
        linear-gradient(135deg, var(--sticker-top), var(--sticker-bottom));
      border:3px solid var(--sticker-edge);
      border-radius:8px;
      box-shadow:0 8px 0 rgba(0,0,0,.08), 0 12px 24px rgba(0,0,0,.2);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
      overflow:visible;
      transform:rotate(-2deg);
    }
    .sticker__text{
      font-size: clamp(16px,2.2vw,20px);
      line-height:1.4;
      text-align:center;
      color:#3b2e2a;
      letter-spacing:.01em;
      max-width:88%;
      max-height:88%;
      overflow:auto;
      white-space:pre-wrap;
      font-weight:600;
    }

    /* Кнопка-вопрос */
    .qbtn{
      position:absolute;
      top:-28px;
      left:50%;
      transform:translateX(-50%) rotate(8deg);
      z-index:3;
      width:64px;
      height:64px;
      border-radius:50%;
      border:4px solid var(--accent-dark);
      background:radial-gradient(circle at 35% 35%, #a9f284, #4fd26a 55%);
      color:#fff;
      font-weight:900;
      font-size:32px;
      display:grid;
      place-items:center;
      cursor:pointer;
      box-shadow:0 6px 0 #25632e, 0 12px 20px rgba(0,0,0,.25);
    }

    /* Меню подсказок */
    .qmenu{
      position:absolute;
      top:-10px;
      left:50%;
      transform:translate(-50%, -100%);
      z-index:4;
      background:var(--menu);
      border:2px solid var(--menu-border);
      border-radius:12px;
      box-shadow:0 10px 18px rgba(0,0,0,.25);
      padding:10px;
      display:flex;
      gap:8px;
      white-space:nowrap;
      align-items:center;
    }
    .qmenu[hidden]{display:none}
    .qmenu button{
      appearance:none;
      border:0;
      border-radius:12px;
      padding:10px 14px;
      cursor:pointer;
      font-weight:800;
      color:#5b3f2f;
      background:linear-gradient(135deg, #fff7bf,#ffe082);
      box-shadow:0 3px 0 #e0b653;
      font-family:inherit;
    }
    .qmenu button:active{transform:translateY(1px)}

    /* Поле ответов */
    .answer{
      display:flex;
      gap:12px;
      justify-content:center;
      margin:20px 0 12px;
      flex-wrap:wrap;
    }
    .slot{
      width:64px;
      height:64px;
      border-radius:50%;
      background:linear-gradient(135deg, #8BACD6, #6B8CAE);
      box-shadow:inset 0 4px 0 rgba(0,0,0,.2), 0 4px 0 rgba(0,0,0,.08);
      display:grid;
      place-items:center;
      color:#fff;
      font-weight:900;
      font-size:28px;
      letter-spacing:.02em;
    }
    .slot.empty{opacity:.35}

    /* Монетки-буквы */
    .choices{
      display:flex;
      gap:12px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top:8px;
    }
    .tile{
      width:70px;
      height:70px;
      border-radius:50%;
      display:grid;
      place-items:center;
      font-weight:900;
      font-size:30px;
      letter-spacing:.02em;
      color:var(--tile-text);
      cursor:pointer;
      user-select:none;
      background:
        radial-gradient(30px 22px at 38% 35%, rgba(255,255,255,.85), rgba(255,255,255,0) 60%),
        linear-gradient(135deg, var(--tile-face-top), var(--tile-face-bottom));
      border:4px solid var(--tile-ring);
      box-shadow:0 6px 0 var(--tile-shadow), 0 10px 18px rgba(0,0,0,.25);
      transition:transform .15s;
    }
    .tile:hover{transform:scale(1.05) rotate(-3deg)}
    .tile.used{
      filter:grayscale(.8);
      opacity:.45;
      cursor:not-allowed;
      transform:scale(.95);
    }

    .controls{
      display:flex;
      gap:10px;
      justify-content:center;
      margin-top:16px;
      flex-wrap:wrap;
    }

    @keyframes shake{
      0%,100%{transform:translateX(0)}
      25%{transform:translateX(-10px)}
      75%{transform:translateX(10px)}
    }
    .shake{animation:shake 0.52s ease-in-out}

    @media (max-width:760px){
      .wrap{padding-left:60px}
      body:before{left:20px}
    }

    /* FX слой */
    #fxLayer{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:999;
      display:none;
    }
    #fxLayer.active{display:block}
    #fxLayer canvas{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
    }
    .toast{
      position:absolute;
      left:50%;
      top:22%;
      transform:translate(-50%,-50%) scale(.9);
      background:rgba(255,255,255,.95);
      padding:16px 24px;
      border-radius:16px;
      font-weight:900;
      font-size:clamp(20px,3.2vw,28px);
      color:#2b1d14;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      opacity:0;
      border:3px solid #FFD93D;
    }
    .toast.show{animation:toastpop 900ms cubic-bezier(.2,.8,.2,1) forwards}
    @keyframes toastpop{
      0%{opacity:0; transform:translate(-50%,-50%) scale(.9) rotate(-5deg)}
      20%{opacity:1; transform:translate(-50%,-50%) scale(1.05) rotate(2deg)}
      60%{transform:translate(-50%,-50%) scale(1) rotate(0deg)}
      100%{opacity:1}
    }

    /* Финальная плашка */
    .finale{
      position:fixed;
      inset:0;
      z-index:1000;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(43,56,86,.5);
      backdrop-filter:blur(8px);
      pointer-events:none;
    }
    .finale.active{display:flex; pointer-events:all}
    .finale__card{
      position:relative;
      width:min(540px, 90vw);
      padding:48px 32px;
      border-radius:20px;
      background:
        radial-gradient(160px 90px at 30% 25%, rgba(255,255,255,.9), rgba(255,255,255,0) 70%),
        linear-gradient(135deg, #FFD93D 0%, #FFAC41 50%, #FF6B6B 100%);
      box-shadow:0 20px 60px rgba(0,0,0,.4), inset 0 2px 0 rgba(255,255,255,.7);
      text-align:center;
      animation:finaleIn 800ms cubic-bezier(.34,1.56,.64,1) forwards;
      border:4px solid #fff;
    }
    @keyframes finaleIn{
      0%{opacity:0; transform:scale(.7) translateY(30px) rotate(-8deg)}
      100%{opacity:1; transform:scale(1) translateY(0) rotate(0deg)}
    }
    .finale__title{
      font-size:clamp(32px, 5vw, 48px);
      font-weight:900;
      margin:0 0 16px;
      background:linear-gradient(135deg, #fff, #ffe169);
      -webkit-background-clip:text;
      background-clip:text;
      -webkit-text-fill-color:transparent;
      filter:drop-shadow(0 2px 4px rgba(0,0,0,.3));
    }
    .finale__score{
      font-size:clamp(64px, 9vw, 96px);
      font-weight:900;
      margin:20px 0;
      color:#fff;
      text-shadow:
        0 4px 12px rgba(0,0,0,.4),
        0 2px 0 rgba(0,0,0,.2),
        0 0 30px rgba(255,217,61,.6);
      animation:scoreGlow 2s ease-in-out infinite;
    }
    @keyframes scoreGlow{
      0%,100%{transform:scale(1)}
      50%{transform:scale(1.1)}
    }
    .finale__label{
      font-size:clamp(18px,2.8vw,26px);
      color:#fff;
      opacity:.95;
      font-weight:700;
      text-shadow:0 2px 6px rgba(0,0,0,.3);
      letter-spacing:1px;
    }
    .finale__btn{
      margin-top:32px;
      appearance:none;
      border:0;
      border-radius:20px;
      padding:16px 36px;
      background:linear-gradient(135deg, #fff, #f5f5f5);
      color:#333;
      font-weight:900;
      font-size:20px;
      cursor:pointer;
      box-shadow:0 6px 0 rgba(0,0,0,.2), 0 10px 20px rgba(0,0,0,.3);
      transition:transform .15s;
      font-family:inherit;
    }
    .finale__btn:hover{transform:translateY(-3px)}
    .finale__btn:active{transform:translateY(1px)}
    .finale__stars{
      position:absolute;
      inset:0;
      pointer-events:none;
      overflow:hidden;
      border-radius:20px;
    }
    .star{
      position:absolute;
      width:10px;
      height:10px;
      background:#fff;
      border-radius:50%;
      animation:starTwinkle 1.5s ease-in-out infinite;
      box-shadow:0 0 10px rgba(255,255,255,.8);
    }
    @keyframes starTwinkle{
      0%,100%{opacity:.3; transform:scale(.8)}
      50%{opacity:1; transform:scale(1.3)}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="hamb" aria-hidden="true"></div>
        <h1>Море загадок — тренажёр для ваших слов</h1>
      </div>
      <div class="panel">
        <input id="file" type="file" accept=".txt,.csv,.json" />
        <button class="btn" id="startBtn" disabled>Старт</button>
        <span class="mini" id="loadedInfo">не загружено</span>
      </div>
    </header>

    <section class="hud">
      <div class="pill" id="progress">Слово 0/0</div>
      <div class="pill" id="score">Очки: 0</div>
    </section>

    <div class="sticker" role="group" aria-label="Определение">
      <button class="qbtn" id="qbtn" aria-haspopup="true" aria-expanded="false" aria-controls="qmenu">?</button>
      <div id="qmenu" class="qmenu" hidden>
        <button data-action="one">Открыть 1 букву</button>
        <button data-action="all">Открыть слово</button>
      </div>
      <div id="definitionText" class="sticker__text">Загрузите файл (1–20 пар) «слово - определение», затем нажмите «Старт»</div>
    </div>

    <main class="board" aria-live="polite" style="display:none;">
      <section>
        <div class="answer" id="answerBox" aria-label="Собранное слово"></div>
        <div class="choices" id="choices"></div>
      </section>
      <section>
        <div class="controls">
          <button class="btn" id="check">Проверить</button>
          <button class="btn" id="undo">Отменить</button>
          <button class="btn secondary" id="shuffle">Перемешать</button>
          <button class="btn secondary" id="skip">Пропустить</button>
        </div>
      </section>
    </main>
  </div>

  <!-- Финальная плашка -->
  <div class="finale" id="finale">
    <div class="finale__card">
      <div class="finale__stars" id="stars"></div>
      <h2 class="finale__title">🎉 Поздравляем! 🎉</h2>
      <div class="finale__score" id="finalScore">0</div>
      <div class="finale__label">ОЧКОВ НАБРАНО</div>
      <button class="finale__btn" id="restart">Играть ещё раз</button>
    </div>
  </div>

  <script>
    const Sound = {
      ctx: null,
      _ctx(){ if(!this.ctx){ this.ctx = new (window.AudioContext||window.webkitAudioContext)(); } return this.ctx;},
      beep(freq=880, ms=120){ const ctx=this._ctx(); const o=ctx.createOscillator(); const g=ctx.createGain(); o.connect(g); g.connect(ctx.destination); o.type='sine'; o.frequency.value=freq; g.gain.value=.001; o.start(); const t=ctx.currentTime; g.gain.exponentialRampToValueAtTime(.2, t+.01); g.gain.exponentialRampToValueAtTime(.0001, t+ms/1000); o.stop(t+ms/1000+0.02); },
      buzz(){ this.beep(220,200); this.beep(140,220); }
    };

    const TypeSound = {
      tick(){
        try{
          const ctx = Sound._ctx();
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.type = 'square';
          o.frequency.value = 1600 + Math.random()*500;
          o.connect(g); g.connect(ctx.destination);
          const t = ctx.currentTime;
          g.gain.setValueAtTime(0, t);
          g.gain.linearRampToValueAtTime(0.18, t+0.005);
          g.gain.exponentialRampToValueAtTime(1e-4, t+0.06);
          o.start(t); o.stop(t+0.07);
        }catch(e){}
      },
      ding(){
        try{
          const ctx = Sound._ctx();
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.type='triangle'; o.frequency.value=880;
          o.connect(g); g.connect(ctx.destination);
          const t=ctx.currentTime;
          g.gain.setValueAtTime(0, t);
          g.gain.linearRampToValueAtTime(0.18, t+0.01);
          g.gain.exponentialRampToValueAtTime(1e-4, t+0.28);
          o.start(t); o.stop(t+0.3);
        }catch(e){}
      }
    };

    const FireSound = {
      burst(){
        try{
          const ctx = Sound._ctx();
          const g = ctx.createGain(); g.connect(ctx.destination);
          const o1 = ctx.createOscillator(); o1.type='sawtooth'; o1.connect(g);
          const o2 = ctx.createOscillator(); o2.type='square'; o2.connect(g);
          const t = ctx.currentTime;
          g.gain.setValueAtTime(0.0001, t);
          g.gain.exponentialRampToValueAtTime(0.35, t+0.06);
          g.gain.exponentialRampToValueAtTime(0.0001, t+0.6);
          o1.frequency.setValueAtTime(1400, t);
          o1.frequency.exponentialRampToValueAtTime(220, t+0.6);
          o2.frequency.setValueAtTime(800, t);
          o2.frequency.exponentialRampToValueAtTime(180, t+0.6);
          o1.start(t); o2.start(t);
          o1.stop(t+0.62); o2.stop(t+0.62);
        }catch(e){}
      }
    };

    function ensureFXLayer(){
      let layer = document.getElementById('fxLayer');
      if(!layer){
        layer = document.createElement('div');
        layer.id = 'fxLayer';
        layer.innerHTML = '<canvas id="fx"></canvas><div id="toast" class="toast"></div>';
        document.body.appendChild(layer);
      }
      return layer;
    }

    function fireworks(duration=1200){
      const layer = ensureFXLayer();
      layer.classList.add('active');
      const canvas = layer.querySelector('#fx');
      const dpr = window.devicePixelRatio || 1;
      const resize = ()=>{ canvas.width=innerWidth*dpr; canvas.height=innerHeight*dpr; };
      resize();
      const ctx = canvas.getContext('2d');
      let start=null; const parts=[]; const cols=['#ffcf3a','#ff6b6b','#7bed9f','#70a1ff','#f78fb3'];
      function spawn(x,y){ for(let i=0;i<100;i++){ const a=Math.random()*Math.PI*2; const v=2+Math.random()*4; parts.push({x,y,vx:Math.cos(a)*v,vy:Math.sin(a)*v,life:1,color:cols[i%cols.length]}); } }
      spawn(canvas.width/2, canvas.height/2);
      spawn(canvas.width*0.25, canvas.height*0.4);
      spawn(canvas.width*0.75, canvas.height*0.35);
      function step(ts){
        if(!start) start=ts; const t=ts-start; ctx.clearRect(0,0,canvas.width,canvas.height);
        for(const p of parts){ p.vy += 0.02*dpr; p.x += p.vx*dpr; p.y += p.vy*dpr; p.life *= 0.985; ctx.globalAlpha=Math.max(p.life,0); ctx.fillStyle=p.color; ctx.beginPath(); ctx.arc(p.x,p.y,2.2*dpr,0,Math.PI*2); ctx.fill(); }
        if(t<duration){ requestAnimationFrame(step); } else { layer.classList.remove('active'); ctx.clearRect(0,0,canvas.width,canvas.height); }
      }
      requestAnimationFrame(step);
    }

    function showSuccessFX(){
      fireworks(1200);
      FireSound.burst();
      const layer = ensureFXLayer();
      const toast = layer.querySelector('#toast');
      toast.textContent = 'Да, молодец!';
      toast.classList.remove('show'); void toast.offsetWidth; toast.classList.add('show');
      layer.classList.add('active');
      setTimeout(()=>{ toast.classList.remove('show'); }, 1200);
    }

    const $ = s=>document.querySelector(s);
    function normalizeWord(s){ return s.toLowerCase().replaceAll('ё','е').replace(/[^a-zа-я]/gi,''); }
    function shuffle(arr){ const a=[...arr]; for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }

    function splitWordDef(line){
      const s = String(line).trim(); if(!s) return null;
      let idx = -1; for(let i=0;i<s.length;i++){ const ch=s[i]; if(ch==='-'||ch==='—'){ const ls=i>0&&/\s/.test(s[i-1]); const rs=i<s.length-1&&/\s/.test(s[i+1]); if(ls||rs) idx=i; }}
      if(idx===-1){ idx=Math.max(s.indexOf('-'), s.indexOf('—')); }
      if(idx===-1) return null; const word=s.slice(0,idx).trim(); const definition=s.slice(idx+1).trim(); if(!word||!definition) return null; return {word, definition};
    }
    function parseTXT_WordDef(text){ return text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l&&!/^#/.test(l)).map(splitWordDef).filter(Boolean); }
    function parseCSV_WordDef(text){ const lines=text.split(/\r?\n/).filter(Boolean); if(!lines.length) return []; let start=0,wi=0,di=1; const head=lines[0].split(',').map(c=>c.trim().toLowerCase()); const hh = head.some(h=>/word|слово/.test(h))||head.some(h=>/definition|определение/.test(h)); if(hh){start=1; wi=Math.max(head.findIndex(h=>/word|слово/.test(h)),0); di=Math.max(head.findIndex(h=>/definition|определение/.test(h)),1);} const out=[]; for(let i=start;i<lines.length;i++){ const row=lines[i].split(','); const w=(row[wi]||'').trim(); const d=(row[di]||'').trim(); if(w&&d) out.push({word:w,definition:d}); } return out; }
    function parseJSON_WordDef(text){ const arr=JSON.parse(text); return Array.isArray(arr)?arr.map(x=>({word:(x.word||x.слово||'').trim(),definition:(x.definition||x.определение||'').trim()})).filter(x=>x.word&&x.definition):[]; }

    async function readFile(f){ const text=await f.text(); const ext=f.name.split('.').pop().toLowerCase(); if(ext==='txt') return parseTXT_WordDef(text); if(ext==='csv') return parseCSV_WordDef(text); if(ext==='json') return parseJSON_WordDef(text); throw new Error('Неподдерживаемый формат. Используйте TXT/CSV/JSON.'); }

    let pendingEntries=[]; let entries=[]; let idx=0; let score=0; let current=null; let slots=[];
    let typeTimer=null; const TYPE_DELAY=16;
    let __TEST_MODE__ = false;

    const elProgress=$('#progress');
    const elScore=$('#score');
    const elDefinition=$('#definitionText');
    const elQBtn=$('#qbtn');
    const elQMenu=$('#qmenu');
    const elBoard=document.querySelector('.board');
    const elAnswer=$('#answerBox');
    const elChoices=$('#choices');
    const elStart=$('#startBtn');
    const elLoaded=$('#loadedInfo');
    const elFinale=$('#finale');
    const elFinalScore=$('#finalScore');

    function updateHUD(){ elProgress.textContent=`Слово ${Math.min(idx+1,entries.length)}/${entries.length}`; elScore.textContent=`Очки: ${score}`; }

    function wordLetters(word){ return word.toUpperCase().split('').filter(ch=>/[A-ZА-ЯЁ]/.test(ch)); }
    function lettersForWord(word){ const letters = wordLetters(word); return letters.map((ch,i)=>({ id:i+':'+Math.random().toString(36).slice(2,7), ch })); }

    function createSlots(count){
      slots = Array.from({length:count},()=>({el:document.createElement('div'), id:null, ch:null}));
      elAnswer.innerHTML='';
      slots.forEach(s=>{ s.el.className='slot empty'; s.el.addEventListener('click',()=>{ if(s.id){ const peer = elChoices.querySelector(`[data-id="${s.id}"]`); if(peer) peer.classList.remove('used'); s.id=null; s.ch=null; s.el.textContent=''; s.el.classList.add('empty'); }}); elAnswer.appendChild(s.el); });
    }

    function firstEmptySlotIndex(){ return slots.findIndex(s=>!s.id); }
    function lastFilledSlotIndex(){ for(let i=slots.length-1;i>=0;i--) if(slots[i].id) return i; return -1; }

    function typeDefinition(text){
      if(typeTimer){ clearInterval(typeTimer); typeTimer=null; }
      elDefinition.textContent='';
      let i=0;
      typeTimer=setInterval(()=>{
        if(i<text.length){
          const ch = text[i++];
          elDefinition.textContent += ch;
          if(ch.trim()!=='') TypeSound.tick();
        } else {
          clearInterval(typeTimer); typeTimer=null; TypeSound.ding();
        }
      }, TYPE_DELAY);
    }

    function renderRound(){
      if(idx>=entries.length){ return finish(); }
      current = entries[idx];
      elChoices.innerHTML='';
      const letters = shuffle(lettersForWord(current.word));
      createSlots( letters.length );
      letters.forEach(letter=>{
        const t=document.createElement('button'); t.className='tile'; t.textContent=letter.ch; t.dataset.id=letter.id;
        t.addEventListener('click',()=>{ if(t.classList.contains('used')) return; const pos=firstEmptySlotIndex(); if(pos===-1) return; t.classList.add('used'); const s=slots[pos]; s.id=letter.id; s.ch=letter.ch; s.el.textContent=letter.ch; s.el.classList.remove('empty'); });
        elChoices.appendChild(t);
      });
      typeDefinition(current.definition);
      hideMenu();
      updateHUD();
    }

    function guessWord(){ return normalizeWord( slots.map(s=>s.ch||'').join('') ); }

    function check(){
      const good = guessWord() === normalizeWord(current.word);
      if(good){
        score += Math.max(10, current.word.length);
        elScore.textContent=`Очки: ${score}`;
        if(!__TEST_MODE__){
          showSuccessFX();
          setTimeout(()=>{ next(); }, 1250);
        } else {
          next();
        }
      } else {
        Sound.buzz();
        elAnswer.classList.add('shake'); 
        setTimeout(()=>elAnswer.classList.remove('shake'),520);
      }
    }

    function next(){ idx++; renderRound(); }

    function undo(){ const i=lastFilledSlotIndex(); if(i===-1) return; const s=slots[i]; const peer=elChoices.querySelector(`[data-id="${s.id}"]`); if(peer) peer.classList.remove('used'); s.id=null; s.ch=null; s.el.textContent=''; s.el.classList.add('empty'); }

    function skip(){ next(); }

    function finish(){ 
      elBoard.style.display='none';
      if(!__TEST_MODE__){
        showFinale();
      }
    }

    function showFinale(){
      elFinalScore.textContent = score;
      elFinale.classList.add('active');
      fireworks(3000);
      FireSound.burst();
      
      const starsContainer = document.getElementById('stars');
      starsContainer.innerHTML = '';
      for(let i=0; i<25; i++){
        const star = document.createElement('div');
        star.className = 'star';
        star.style.left = Math.random()*100 + '%';
        star.style.top = Math.random()*100 + '%';
        star.style.animationDelay = Math.random()*1.5 + 's';
        starsContainer.appendChild(star);
      }
    }

    function setPending(list){
      const cleaned = (list||[])
        .filter(x=>x&&x.word&&x.definition)
        .map(x=>({word:String(x.word).trim(), definition:String(x.definition).trim()}))
        .filter(x=>x.word&&x.definition)
        .slice(0,20);
      
      pendingEntries = cleaned;
      const n = cleaned.length;
      elLoaded.textContent = `загружено пар: ${n}`;
      
      if(n > 0){
        elStart.disabled = false;
        elDefinition.textContent = 'Нажмите «Старт», чтобы начать.';
      } else {
        elStart.disabled = true;
        elDefinition.textContent = 'Загрузите файл (1–20 пар) «слово - определение», затем нажмите «Старт»';
      }
    }

    function targetLetters(){ return wordLetters(current.word); }

    function hintOneLetter(){
      if(!current) return;
      const target = targetLetters();
      let i = -1;
      for(let k=0;k<slots.length;k++){ const wrong = !slots[k].ch || slots[k].ch!==target[k]; if(wrong){ i=k; break; }}
      if(i===-1) return;
      if(slots[i].id && slots[i].ch!==target[i]){
        const old = slots[i]; const oldPeer = elChoices.querySelector(`[data-id="${old.id}"]`); if(oldPeer) oldPeer.classList.remove('used'); old.id=null; old.ch=null; old.el.textContent=''; old.el.classList.add('empty');
      }
      const tiles = Array.from(elChoices.querySelectorAll('.tile'));
      let tile = tiles.find(t=>!t.classList.contains('used') && t.textContent===target[i]);
      if(tile){
        tile.classList.add('used'); slots[i].id=tile.dataset.id; slots[i].ch=tile.textContent; slots[i].el.textContent=tile.textContent; slots[i].el.classList.remove('empty');
      } else {
        const j = slots.findIndex((s,idx)=> idx!==i && s.ch===target[i]);
        if(j>-1){ slots[i].id=slots[j].id; slots[i].ch=slots[j].ch; slots[i].el.textContent=slots[j].ch; slots[i].el.classList.remove('empty'); slots[j].id=null; slots[j].ch=null; slots[j].el.textContent=''; slots[j].el.classList.add('empty'); }
      }
    }

    function hintRevealWord(){
      if(!current) return;
      const target = targetLetters();
      slots.forEach(s=>{ if(s.id){ const peer=elChoices.querySelector(`[data-id="${s.id}"]`); if(peer) peer.classList.remove('used'); s.id=null; s.ch=null; s.el.textContent=''; s.el.classList.add('empty'); }});
      const tiles = Array.from(elChoices.querySelectorAll('.tile'));
      for(let i=0;i<target.length;i++){
        const tile = tiles.find(t=>!t.classList.contains('used') && t.textContent===target[i]);
        if(tile){ tile.classList.add('used'); slots[i].id=tile.dataset.id; slots[i].ch=tile.textContent; slots[i].el.textContent=tile.textContent; slots[i].el.classList.remove('empty'); }
      }
    }

    function showMenu(){ elQMenu.hidden=false; elQBtn.setAttribute('aria-expanded','true'); }
    function hideMenu(){ elQMenu.hidden=true; elQBtn.setAttribute('aria-expanded','false'); }
    function toggleMenu(){ if(elQMenu.hidden) showMenu(); else hideMenu(); }

    document.getElementById('file').addEventListener('change', async (e)=>{ 
      const f=e.target.files?.[0]; 
      if(!f) return; 
      try{ 
        const list=await readFile(f); 
        setPending(list);
      }catch(err){ 
        alert(err.message||err); 
      } 
    });

    function startGame(){
      if(!pendingEntries || pendingEntries.length===0){
        Sound.buzz();
        return;
      }
      entries=shuffle(pendingEntries);
      idx=0; 
      score=0;
      elFinale.classList.remove('active');
      document.querySelector('.board').style.display='block';
      renderRound(); 
      updateHUD();
    }

    document.getElementById('startBtn').addEventListener('click', startGame);
    document.getElementById('restart').addEventListener('click', ()=>{
      elFinale.classList.remove('active');
      startGame();
    });
    document.getElementById('check').addEventListener('click', check);
    document.getElementById('undo').addEventListener('click', undo);
    document.getElementById('shuffle').addEventListener('click', ()=>{ if(current) renderRound(); });
    document.getElementById('skip').addEventListener('click', skip);

    elQBtn.addEventListener('click', (e)=>{ e.stopPropagation(); toggleMenu(); });
    elQMenu.addEventListener('click', (e)=>{ const btn=e.target.closest('button'); if(!btn) return; const act=btn.dataset.action; if(act==='one') hintOneLetter(); if(act==='all') hintRevealWord(); hideMenu(); });
    document.addEventListener('pointerdown', (e)=>{ if(!elQMenu.hidden && !e.target.closest('.qmenu') && e.target!==elQBtn){ hideMenu(); } });

    (function(){
      try{
        const a=(c,m)=>{if(!c) throw new Error(m)};
        a(normalizeWord('Ёж-ик!')==='ежик','normalizeWord');
        const p = splitWordDef('юла - кручусь, верчусь...');
        a(p && p.word==='юла' && p.definition.startsWith('кручусь'),'splitWordDef');
        const wl = (w)=> w.toUpperCase().split('').filter(ch=>/[A-ZА-ЯЁ]/.test(ch));
        const arr = wl('аппарат');
        const count = ch => arr.filter(x=>x===ch).length;
        a(arr.length===7 && count('А')===3 && count('П')===2,'wordLetters duplicates');
        createSlots(3);
        a(firstEmptySlotIndex()===0,'firstEmptySlotIndex at start');
        slots[0].id='t1'; slots[0].ch='А'; slots[0].el.textContent='А'; slots[0].el.classList.remove('empty');
        a(firstEmptySlotIndex()===1 && lastFilledSlotIndex()===0,'slot indices after one fill');
        const st = getComputedStyle(document.querySelector('.sticker'));
        a(st.overflowX!=='hidden' && st.overflowY!=='hidden','sticker overflow visible');
        ensureFXLayer();
        a(!!document.getElementById('fxLayer'),'fx layer exists');
        entries=[{word:'А',definition:'буква а'}]; idx=0; current=entries[0];
        createSlots(1); slots[0].ch='А'; slots[0].id='test'; slots[0].el.textContent='А'; slots[0].el.classList.remove('empty');
        const before=score; __TEST_MODE__=true; check(); __TEST_MODE__=false; a(score>before,'check() increments score on success');
        setPending([{word:'Кот',definition:'животное'},{word:'Дом',definition:'жилище'}]);
        a(!document.getElementById('startBtn').disabled,'start enabled for <20');
        console.log('%cSelf-tests passed','color:#2ecc71;font-weight:700');
      }catch(e){ console.error('Self-tests failed:', e.message); }
    })();
  </script>
</body>
</html>